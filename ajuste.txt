## üî¥ BUG IDENTIFICADO: Token e Key n√£o chegam aos headers

### **Arquivo 1: https://github.com/mikesobarboza/wa-quote-bridge/tree/main/QR%20MK/recharge_handler.js#L0-L413 (sendRechargeViaMainWorld)**

#### ‚úÖ EST√Å CORRETO - Envia token/key separadamente
**Localiza√ß√£o:** [QR https://github.com/mikesobarboza/wa-quote-bridge/tree/main/QR%20MK/recharge_handler.js#L0-L413 linhas 264-296](https://github.com/mikesobarboza/wa-quote-bridge/tree/main/QR%20MK/recharge_handler.js#L264-L296)

```javascript
function sendRechargeViaMainWorld(data, token, key, url = 'https://d1yoh197nyhh3m.bzcfgm.com/api/v1/user/recharge', method = 'POST') {
    return new Promise((resolve) => {
        const mainRequestId = 'main_' + Date.now() + '_' + Math.random().toString(36).slice(2);

        function handler(event) {
            if (event.source !== window) return;
            const msg = event.data;
            if (!msg || msg.type !== 'ICE_RECHARGE_RESPONSE_MAIN') return;
            if (msg.requestId !== mainRequestId) return;

            window.removeEventListener('message', handler);
            resolve(msg);
        }

        window.addEventListener('message', handler);

        window.postMessage({
            type: 'ICE_RECHARGE_REQUEST_MAIN',
            requestId: mainRequestId,
            data,      // ‚úÖ Payload com uid, key, amount, etc
            token,     // ‚úÖ Token separado (32 chars hex)
            key,       // ‚úÖ Key separada (alphanumeric)
            url,
            method
        }, '*');

        setTimeout(() => {
            window.removeEventListener('message', handler);
            resolve({ ok: false, error: 'MAIN world timeout' });
        }, 15000);
    });
}
```

---

### **Arquivo 2: https://github.com/mikesobarboza/wa-quote-bridge/tree/main/QR%20MK/interceptor_main.js#L1032-L1147**

#### ‚ùå C√ìDIGO ATUAL (COM BUG)
**Localiza√ß√£o:** [QR https://github.com/mikesobarboza/wa-quote-bridge/tree/main/QR%20MK/interceptor_main.js#L1032-L1147 linhas 1137-1171](https://github.com/mikesobarboza/wa-quote-bridge/tree/main/QR%20MK/interceptor_main.js#L1137-L1171)

```javascript
window.addEventListener('message', async (event) => {
    if (event.source !== window) return;
    const payload = event.data;
    if (!payload || payload.type !== 'ICE_RECHARGE_REQUEST_MAIN') return;

    const { requestId, data } = payload;
    const url = payload.url || 'https://d1yoh197nyhh3m.bzcfgm.com/api/v1/user/recharge';
    const method = payload.method || 'POST';
    
    try {
        // ‚ùå BUG: S√≥ passa `data`, mas token e key est√£o em payload.token e payload.key
        const execResult = await executeRechargeInPage({ url, method, bodyData: data });
        let responseData = execResult.body ?? null;
        if (execResult.success && typeof responseData === 'string') {
            try {
                responseData = JSON.parse(responseData);
            } catch (e) {
                // manter texto bruto
            }
        }

        window.postMessage({
            type: 'ICE_RECHARGE_RESPONSE_MAIN',
            requestId,
            ok: !!execResult.success,
            status: execResult.status || 0,
            data: execResult.success ? responseData : null,
            error: execResult.success ? undefined : execResult.error
        }, '*');
    } catch (err) {
        window.postMessage({
            type: 'ICE_RECHARGE_RESPONSE_MAIN',
            requestId,
            ok: false,
            error: err?.message || String(err)
        }, '*');
    }
});
```

**Localiza√ß√£o:** [QR https://github.com/mikesobarboza/wa-quote-bridge/tree/main/QR%20MK/interceptor_main.js#L1032-L1147 linhas 1042-1071](https://github.com/mikesobarboza/wa-quote-bridge/tree/main/QR%20MK/interceptor_main.js#L1042-L1071)

```javascript
async function executeRechargeInPage({ url, method = 'POST', bodyData }) {
    return (async function() {
        try {
            // ‚ùå BUG: Tenta extrair token/key do bodyData, mas eles n√£o est√£o l√°!
            let axiosData = bodyData;
            let tokenFromPayload = null;
            let keyFromPayload = null;
            
            if (typeof bodyData === 'object' && bodyData !== null) {
                tokenFromPayload = bodyData.token;  // ‚ùå bodyData.token √© undefined!
                keyFromPayload = bodyData.key;      // ‚ùå bodyData.key existe mas √© do body, n√£o header!
                axiosData = new URLSearchParams(bodyData).toString();
            }

            // 1) window.axios
            if (window.axios) {
                try {
                    const axiosConfig = {
                        method: method.toLowerCase(),
                        url,
                        data: axiosData,
                        headers: {
                            'Accept': 'application/json, text/plain, */*',
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'token': tokenFromPayload,  // ‚ùå undefined ou null
                            'key': keyFromPayload       // ‚ùå valor do body, n√£o o token header
                        }
                    };

                    const axiosResponse = await window.axios(axiosConfig);
                    return { success: true, status: axiosResponse?.status ?? 0, body: JSON.stringify(axiosResponse.data) };
                } catch (axiosError) {
                    if (axiosError.response) {
                        return {
                            success: false,
                            status: axiosError.response.status,
                            error: JSON.stringify(axiosError.response.data || axiosError.message)
                        };
                    }
                }
            }
            
            // ... (resto do c√≥digo com mesmo problema)
```

---

#### ‚úÖ C√ìDIGO CORRIGIDO

**Localiza√ß√£o:** [QR https://github.com/mikesobarboza/wa-quote-bridge/tree/main/QR%20MK/interceptor_main.js#L1032-L1147 linhas 1137-1171](https://github.com/mikesobarboza/wa-quote-bridge/tree/main/QR%20MK/interceptor_main.js#L1137-L1171)

```javascript
window.addEventListener('message', async (event) => {
    if (event.source !== window) return;
    const payload = event.data;
    if (!payload || payload.type !== 'ICE_RECHARGE_REQUEST_MAIN') return;

    const { requestId, data } = payload;
    const url = payload.url || 'https://d1yoh197nyhh3m.bzcfgm.com/api/v1/user/recharge';
    const method = payload.method || 'POST';
    
    try {
        // ‚úÖ FIX: Passa token e key separadamente
        const execResult = await executeRechargeInPage({ 
            url, 
            method, 
            bodyData: data,
            token: payload.token,  // ‚úÖ ADICIONADO
            key: payload.key        // ‚úÖ ADICIONADO
        });
        let responseData = execResult.body ?? null;
        if (execResult.success && typeof responseData === 'string') {
            try {
                responseData = JSON.parse(responseData);
            } catch (e) {
                // manter texto bruto
            }
        }

        window.postMessage({
            type: 'ICE_RECHARGE_RESPONSE_MAIN',
            requestId,
            ok: !!execResult.success,
            status: execResult.status || 0,
            data: execResult.success ? responseData : null,
            error: execResult.success ? undefined : execResult.error
        }, '*');
    } catch (err) {
        window.postMessage({
            type: 'ICE_RECHARGE_RESPONSE_MAIN',
            requestId,
            ok: false,
            error: err?.message || String(err)
        }, '*');
    }
});
```

**Localiza√ß√£o:** [QR https://github.com/mikesobarboza/wa-quote-bridge/tree/main/QR%20MK/interceptor_main.js#L1032-L1147 linhas 1042-1124](https://github.com/mikesobarboza/wa-quote-bridge/tree/main/QR%20MK/interceptor_main.js#L1042-L1124)

```javascript
// ‚úÖ FIX: Adiciona token e key como par√¢metros da fun√ß√£o
async function executeRechargeInPage({ url, method = 'POST', bodyData, token, key }) {
    return (async function() {
        try {
            // ‚úÖ FIX: Usa os par√¢metros token/key recebidos
            let axiosData = bodyData;
            let tokenFromPayload = token;  // ‚úÖ Usa par√¢metro direto
            let keyFromPayload = key;      // ‚úÖ Usa par√¢metro direto
            
            if (typeof bodyData === 'object' && bodyData !== null) {
                // ‚úÖ Se n√£o veio nos par√¢metros, tenta bodyData como fallback
                if (!tokenFromPayload) tokenFromPayload = bodyData.token;
                if (!keyFromPayload) keyFromPayload = bodyData.key;
                axiosData = new URLSearchParams(bodyData).toString();
            }

            // 1) window.axios
            if (window.axios) {
                try {
                    const axiosConfig = {
                        method: method.toLowerCase(),
                        url,
                        data: axiosData,
                        headers: {
                            'Accept': 'application/json, text/plain, */*',
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'token': tokenFromPayload,  // ‚úÖ Agora tem o valor correto
                            'key': keyFromPayload       // ‚úÖ Agora tem o valor correto
                        }
                    };

                    const axiosResponse = await window.axios(axiosConfig);
                    return { success: true, status: axiosResponse?.status ?? 0, body: JSON.stringify(axiosResponse.data) };
                } catch (axiosError) {
                    if (axiosError.response) {
                        return {
                            success: false,
                            status: axiosError.response.status,
                            error: JSON.stringify(axiosError.response.data || axiosError.message)
                        };
                    }
                }
            }

            // 2) axios em m√≥dulos comuns
            const axiosLocations = [
                window.__NUXT__?.axios,
                window.__NUXT__?.$axios,
                window.$nuxt?.$axios,
                window.app?.axios,
                window.Vue?.prototype?.$axios
            ].filter(Boolean);

            for (const ax of axiosLocations) {
                if (ax && typeof ax === 'function') {
                    try {
                        const axiosConfig = {
                            method: method.toLowerCase(),
                            url,
                            data: axiosData,
                            headers: {
                                'Accept': 'application/json, text/plain, */*',
                                'Content-Type': 'application/x-www-form-urlencoded',
                                'token': tokenFromPayload,  // ‚úÖ Agora tem o valor correto
                                'key': keyFromPayload       // ‚úÖ Agora tem o valor correto
                            }
                        };

                        const axiosResponse = await ax(axiosConfig);
                        return { success: true, status: axiosResponse?.status ?? 0, body: JSON.stringify(axiosResponse.data) };
                    } catch {}
                }
            }

            // 3) fetch fallback (usa cookies do site automaticamente)
            const fetchResponse = await fetch(url, {
                method,
                headers: { 
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'Accept': 'application/json, text/plain, */*',
                    'token': tokenFromPayload,  // ‚úÖ Agora tem o valor correto
                    'key': keyFromPayload       // ‚úÖ Agora tem o valor correto
                },
                body: method !== 'GET'
                    ? (typeof bodyData === 'string' ? bodyData : new URLSearchParams(bodyData).toString())
                    : undefined,
                credentials: 'include'
            });

            const text = await fetchResponse.text();
            if (!fetchResponse.ok) {
                return { success: false, status: fetchResponse.status, error: text };
            }
            return { success: true, status: fetchResponse.status, body: text };
        } catch (error) {
            return { success: false, error: error.message };
        }
    })();
}
```

---

## üìä RESUMO DO BUG

| Item | Origem | Destino | Status |
|------|--------|---------|--------|
| **Payload (data)** | https://github.com/mikesobarboza/wa-quote-bridge/tree/main/QR%20MK/recharge_handler.js#L0-L413 ‚Üí `postMessage.data` | https://github.com/mikesobarboza/wa-quote-bridge/tree/main/QR%20MK/interceptor_main.js#L1032-L1147 ‚Üí `executeRechargeInPage.bodyData` | ‚úÖ OK |
| **Token (header)** | https://github.com/mikesobarboza/wa-quote-bridge/tree/main/QR%20MK/recharge_handler.js#L0-L413 ‚Üí `postMessage.token` | ‚ùå **PERDIDO** - n√£o chegava em `executeRechargeInPage` | ‚ùå BUG |
| **Key (header)** | https://github.com/mikesobarboza/wa-quote-bridge/tree/main/QR%20MK/recharge_handler.js#L0-L413 ‚Üí `postMessage.key` | ‚ùå **PERDIDO** - n√£o chegava em `executeRechargeInPage` | ‚ùå BUG |

### ‚ùå RESULTADO ATUAL (COM BUG):
```
Headers enviados: {
  Accept: "application/json, text/plain, */*",
  Content-Type: "application/x-www-form-urlencoded",
  token: undefined,  // ‚ùå FALTANDO!
  key: "WVvWGWWZMgRwdTCTUSrH"  // ‚ö†Ô∏è Valor do body, n√£o do token header
}
```

### ‚úÖ RESULTADO ESPERADO (AP√ìS FIX):
```
Headers enviados: {
  Accept: "application/json, text/plain, */*",
  Content-Type: "application/x-www-form-urlencoded",
  token: "296b2f41577a0cc6af649adb1c0b578f",  // ‚úÖ CORRETO!
  key: "WVvWGWWZMgRwdTCTUSrH"  // ‚úÖ CORRETO!
}
```

Esse fix resolve completamente o "error sign"! üéØ